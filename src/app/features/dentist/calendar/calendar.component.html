<div class="calendar-page">
  <h2 class="calendar-title">üóìÔ∏è {{"CALENDAR.WEEKLY_APPOINTMENTS" | translate }}</h2>
  <div class="calendar-legend">
    <ul>
      <li *ngFor="let item of legendItems">
        <span class="legend-circle" [style.backgroundColor]="item.color"></span>
        {{ "SERVICE_ID." + item.id | translate }}
      </li>
    </ul>
  </div>
  <div class="calendar-container">
    <full-calendar [options]='calendarOptions()'>
    </full-calendar>
  </div>
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="onCancelClick()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>üìÖ {{"CALENDAR.NEW_APPOINTMENT" | translate }}</h3>
      <p><strong>{{"CALENDAR.START" | translate }}:</strong> {{ selectedStart }}</p>
      <p><strong>{{"CALENDAR.END" | translate }}:</strong> {{ selectedEnd }}</p>

      <form [formGroup]="appointmentForm" (ngSubmit)="createAppointment()">

        <!-- ‚úÖ NEW: Modern Patient Dropdown -->
        <label>{{"CALENDAR.PATIENT" | translate }}</label>
        <div class="patient-search-wrapper">
          <input
            type="text"
            [(ngModel)]="patientSearchTerm"
            [ngModelOptions]="{standalone: true}"
            (input)="onPatientSearchInput()"
            (focus)="showPatientDropdown = true"
            placeholder="{{'CALENDAR.SEARCH_PATIENT' | translate}}"
            class="search-input"
          />

          <button
            type="button"
            *ngIf="patientSearchTerm"
            class="clear-btn"
            (click)="clearPatientSelection()"
            title="Clear">
            ‚úï
          </button>

          <div
            class="dropdown-list patient-dropdown"
            *ngIf="showPatientDropdown && filteredPatients.length > 0"
            (click)="$event.stopPropagation()">
            <div
              *ngFor="let patient of filteredPatients"
              class="dropdown-item"
              (click)="selectPatient(patient)">
              <span class="item-name">{{ patient.firstName }} {{ patient.lastName }}</span>
              <span class="item-detail">{{ patient.email }}</span>
            </div>
          </div>

          <div
            class="dropdown-list no-results"
            *ngIf="showPatientDropdown && filteredPatients.length === 0">
            <p>{{'CALENDAR.NO_PATIENTS_FOUND' | translate}}</p>
          </div>
        </div>

        <!-- ‚úÖ NEW: Modern Service Dropdown -->
        <label>{{"CALENDAR.SERVICE" | translate }}</label>
        <div class="service-search-wrapper">
          <input
            type="text"
            [(ngModel)]="serviceSearchTerm"
            [ngModelOptions]="{standalone: true}"
            (input)="onServiceSearchInput()"
            (focus)="showServiceDropdown = true"
            placeholder="{{'CALENDAR.SEARCH_SERVICE' | translate}}"
            class="search-input"
          />

          <button
            type="button"
            *ngIf="serviceSearchTerm"
            class="clear-btn"
            (click)="clearServiceSelection()"
            title="Clear">
            ‚úï
          </button>

          <div
            class="dropdown-list service-dropdown"
            *ngIf="showServiceDropdown && filteredServices.length > 0"
            (click)="$event.stopPropagation()">
            <div
              *ngFor="let service of filteredServices"
              class="dropdown-item"
              (click)="selectService(service)">
              <span class="item-name">{{ "SERVICE_ID." + service.service.id | translate }}</span>
              <span class="item-price" *ngIf="service.price">{{ service.price | currency:'RSD' }}</span>
            </div>
          </div>

          <div
            class="dropdown-list no-results"
            *ngIf="showServiceDropdown && filteredServices.length === 0">
            <p>{{'CALENDAR.NO_SERVICES_FOUND' | translate}}</p>
          </div>
        </div>

        <label>{{"CALENDAR.NOTES" | translate }}</label>
        <textarea formControlName="notes"></textarea>

        <div class="modal-actions">
          <button type="submit" [disabled]="appointmentForm.invalid">‚úÖ {{"CALENDAR.SAVE" | translate }}</button>
          <button type="button" (click)="onCancelClick()">‚ùå {{"CALENDAR.CANCEL" | translate }}</button>
        </div>
      </form>
    </div>
  </div>
  <div *ngIf="showEditModal" class="modal-overlay">
    <div class="modal-content">
      <h3>‚úèÔ∏è {{"CALENDAR.EDIT_APPOINTMENT" | translate }}</h3>
      <p><strong>{{"CALENDAR.PATIENT" | translate }}:</strong> {{ selectedAppointment?.patient?.firstName }} {{ selectedAppointment?.patient?.lastName }}</p>
      <p><strong>{{"CALENDAR.SERVICE" | translate }}:</strong> {{ selectedAppointment?.service?.name }}</p>
      <p><strong>{{"DENTIST_APPOINTMENTS.DATE" | translate }}:</strong> {{ selectedAppointment?.appointmentDate }}</p>
      <p><strong>{{"DENTIST_APPOINTMENTS.TIME" | translate }}:</strong> {{ selectedAppointment?.startTime }} - {{ selectedAppointment?.endTime }}</p>
      <form [formGroup]="editForm" (ngSubmit)="updateAppointment()">
        <label>{{"BOOKING_CONFIRMATION.STATUS" | translate }}</label>
        <select formControlName="status">
          <option value="SCHEDULED">{{"STATUS.SCHEDULED" | translate }}</option>
          <option value="COMPLETED">{{"STATUS.COMPLETED" | translate }}</option>
          <option value="CANCELLED">{{"STATUS.CANCELLED" | translate }}</option>
        </select>

        <label>{{"CALENDAR.NOTES" | translate }}</label>
        <textarea formControlName="notes"></textarea>

        <div class="modal-actions">
          <button type="submit">üíæ {{"CALENDAR.SAVE" | translate }}</button>
          <button type="button" (click)="showEditModal = false">‚ùå {{"CALENDAR.CANCEL" | translate }}</button>
        </div>
      </form>
    </div>
  </div>


</div>
